Bootstrap: docker
From: python:3.9-slim

%startscript
    # this is necessary to start the benchmarking server
    flask run

%environment
    # this is necessary to start the benchmarking server
    export FLASK_APP=/benchmarking/smacbenchmarking/container/container_script_problem.py

    export XDG_CONFIG_HOME=/benchmarking/container_recipes/benchmarks/hpobench
    export XDG_CACHE_HOME=/benchmarking/.cache/hpobench
    export XDG_DATA_HOME=/benchmarking/.local/share/hpobench
    export TMPDIR=/benchmarking/tmp/hpobench_socket/

%files
    ./smacbenchmarking /benchmarking/smacbenchmarking
    ./container_recipes /benchmarking/container_recipes
    requirements.txt /benchmarking/requirements.txt
    setup.py /benchmarking/setup.py
    README.md /benchmarking/README.md

%post
    apt update -y
    apt upgrade -y
    apt install curl -y
    apt install wget -y
    apt install git -y
    apt install gcc -y
    apt install build-essential -y
    apt install clang -y

    pip install wheel
    pip install -r /benchmarking/requirements.txt
    pip install ../benchmarking
    pip install -r /benchmarking/container_recipes/general/general_requirements_container_problem.txt

    # log benchmarking version
    BENCHMARKING_VERSION=$(python -c "import smacbenchmarking; print(smacbenchmarking.version)")
    echo "benchmarking_version $BENCHMARKING_VERSION" >> "$SINGULARITY_LABELS"

    # benchmark-specific commands go here
    cd /benchmarking/smacbenchmarking
    git clone https://github.com/automl/HPOBench.git
    cd HPOBench
    git checkout 47bf141f79e6bdfb26d1f1218b5d5aac09d7d2ce
    pip install .
    pip install -r /benchmarking/container_recipes/benchmarks/hpobench/hpobench_requirements.txt

    chmod -R 755 /benchmarking
    mkdir /var/lib/hpobench
    chmod -R 755 /var/lib/hpobench
    mkdir /var/lib/hpobench/socket
    mkdir /var/lib/hpobench/data
    mkdir /var/lib/hpobench/cache

  echo "Successfully installed all features"